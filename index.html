<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Python Web Calculator</title>
</head>
<body>
  <h1>Калькулятор</h1>

  <div id="expr">0</div>
  <div id="result"></div>

  <div id="keys">
    <button data-value="7">7</button>
    <button data-value="8">8</button>
    <button data-value="9">9</button>
    <button data-value="+">+</button>
    <br>
    <button data-value="4">4</button>
    <button data-value="5">5</button>
    <button data-value="6">6</button>
    <button data-value="-">-</button>
    <br>
    <button data-value="1">1</button>
    <button data-value="2">2</button>
    <button data-value="3">3</button>
    <button data-value="*">*</button>
    <br>
    <button data-value="0">0</button>
    <button data-value=".">.</button>
    <button data-action="equals">=</button>
    <button data-value="/">/</button>
    <br>
    <button data-action="clear">C</button>
  </div>

  <!-- Pyodide loader -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <script>
    const pythonCode = `
import ast, operator as _op

_allowed_ops = {
    ast.Add: _op.add,
    ast.Sub: _op.sub,
    ast.Mult: _op.mul,
    ast.Div: _op.truediv,
    ast.Pow: _op.pow,
    ast.Mod: _op.mod,
    ast.UAdd: lambda x: x,
    ast.USub: _op.neg,
}

def _eval(node):
    if isinstance(node, ast.BinOp):
        return _allowed_ops[type(node.op)](_eval(node.left), _eval(node.right))
    elif isinstance(node, ast.UnaryOp):
        return _allowed_ops[type(node.op)](_eval(node.operand))
    elif isinstance(node, ast.Num):
        return node.n
    elif hasattr(ast, 'Constant') and isinstance(node, ast.Constant):
        if isinstance(node.value, (int, float)):
            return node.value
        else:
            raise ValueError('Only numeric constants allowed')
    elif isinstance(node, ast.Expression):
        return _eval(node.body)
    else:
        raise ValueError('Unsupported expression')

def safe_eval(expr: str):
    node = ast.parse(expr, mode='eval')
    return _eval(node)
`;

    let pyodide = null;
    let ready = false;

    async function initPyodideAndLoad() {
      if (ready) return;
      pyodide = await loadPyodide();
      await pyodide.runPythonAsync(pythonCode);
      ready = true;
    }

    const exprEl = document.getElementById('expr');
    const resultEl = document.getElementById('result');
    const keys = document.getElementById('keys');

    function setExpr(v){ exprEl.textContent = v || '0'; }
    function getExpr(){ return exprEl.textContent === '0' ? '' : exprEl.textContent; }

    function appendValue(val){
      let cur = getExpr();
      cur = cur + val;
      setExpr(cur);
    }

    function clearAll(){ setExpr('0'); resultEl.textContent = ''; }

    async function evaluateExpression(){
      await initPyodideAndLoad();
      let expr = getExpr();
      if (!expr) return;
      try {
        pyodide.globals.set('expr_from_js', expr);
        const res = pyodide.runPython('safe_eval(expr_from_js)');
        resultEl.textContent = String(res);
      } catch (err) {
        resultEl.textContent = 'Error';
      }
    }

    keys.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const val = btn.getAttribute('data-value');
      const action = btn.getAttribute('data-action');
      if (action === 'clear') return clearAll();
      if (action === 'equals') return evaluateExpression();
      if (val) return appendValue(val);
    });

    initPyodideAndLoad();
  </script>
</body>
</html>
